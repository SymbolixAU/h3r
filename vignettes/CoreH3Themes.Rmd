---
title: "Core H3 Themes"
output: html_document
author: "Ray Shao"
date: "2023-07-20"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


## Core H3 Themes

There's lots of really [good content and documentation]() on the fundamentals of H3 available, so we're not going to introduce the core themes here, but rather show how you can use them in R through `h3r`


```{r}
library(mapdeck)
library(data.table)
library(h3r)
```

## Resolution 0

Resolution 0 cells are the [largest](https://h3geo.org/docs/core-library/restable#average-area-in-km2) (i.e, they cover the largest area, and resolution 15 are the smallest). The whole globe is covered with cells at each resolution. 

We're using the term 'cells', because each resolution is made up of some number of hexagons, and exactly 12 pentagons.

If we plot all the Resolution 0 cells on a 'flat' map we get distortions as the cells get further from the equator. This is purely a result of plotting using the Mercator projection. However, all hexagons at each resolution are roughly the same size.

```{r resolution0, fig.cap="resolution 0 cells"}
mapdeck::set_token(secret::get_secret("MAPBOX"))

cells <- h3r::getRes0Cells()

mapdeck(libraries = "h3", style = mapdeck_style("dark"))  %>%
  add_h3(
    data = data.frame(x = cells)
    , hexagon = "x"
    , fill_colour = "x"
    , fill_opacity = 0.7
    , tooltip = "x"
    , stroke_colour = "#000000"
    , stroke_width = 50000
  )
```

### Pentagons

The reason for using pentagons is summarised by [Uber](https://h3geo.org/docs/core-library/overview/)

> The H3 grid is constructed on the icosahedron by recursively creating increasingly higher precision hexagon grids until the desired resolution is achieved. Note that it is impossible to tile the sphere/icosahedron completely with hexagons; each resolution of an icosahedral hexagon grid must contain exactly 12 pentagons at every resolution, with one pentagon centered on each of the icosahedron vertices. 

The nice feature about the pentagons is that they are all centered in the ocean.


```{r}
mapdeck::set_token(secret::get_secret("MAPBOX"))

cells <- h3r::getRes0Cells()
is_pentagon = h3r::isPentagon(cells)

mapdeck(libraries = "h3", style = mapdeck_style("dark"))  %>%
  add_h3(
    data = data.frame(x = cells, is_pentagon = is_pentagon)
    , hexagon = "x"
    , fill_colour = "is_pentagon"
    , fill_opacity = 0.5
    , tooltip = "x"
    , stroke_colour = "#000000"
    , stroke_width = 50000
  )
```

\

### Icosahedron faces

Those 122 resolution 0 cells live in 20 faces. Let's see which faces are they in.

```{r}

cells <- h3r::getRes0Cells()
faces <- h3r::getIcosahedronFaces(cells)

## collapse the faces into a string of face IDs for each cell
faces <- sapply(faces, \(x) unlist(paste0(x, collapse = ","))) |> unname()

df_faces <- data.frame(
  cell = cells
  , face = faces
  )

mapdeck(libraries = "h3", style = mapdeck_style("dark"))  %>%
    add_h3(
        data = df_faces
        , hexagon = "cell"
        , fill_colour = "face"
        , fill_opacity = 0.7
        , tooltip = "face"
        , stroke_colour = "#000000"
        , stroke_width = 50000
    )
```

If you hover over the cells you can notice that some intersect multiple faces. 

\

### Changing Resolution


The center cells of each face are hexagons

```{r}
mapdeck::set_token(secret::get_secret("MAPBOX"))

cells <- c(
  '8021fffffffffff', '8005fffffffffff', '800ffffffffffff', '8035fffffffffff',
  '803ffffffffffff', '8065fffffffffff', '8033fffffffffff', '8049fffffffffff', '8081fffffffffff', '8097fffffffffff', '8073fffffffffff', '805dfffffffffff',
  '808ffffffffffff', '80c1fffffffffff', '80abfffffffffff', '80bffffffffffff',
  '80b5fffffffffff', '80d3fffffffffff', '80effffffffffff', '80e5fffffffffff'
  )

mapdeck(libraries = "h3", style = mapdeck_style("dark"))  %>%
  add_h3(
    data = data.frame(x = cells)
    , hexagon = "x"
    , fill_colour = "x"
    , fill_opacity = 0.7
    , tooltip = "x"
    , stroke_colour = "#000000"
    , stroke_width = 50000
  )
```

\

If we also plot the children of each cell (By going up to resolution 1) we see there are approximtely 7 children per cell.

```{r}
mapdeck::set_token(secret::get_secret("MAPBOX"))

cells <- c(
  '8021fffffffffff', '8005fffffffffff', '800ffffffffffff', '8035fffffffffff',
  '803ffffffffffff', '8065fffffffffff', '8033fffffffffff', '8049fffffffffff', '8081fffffffffff', '8097fffffffffff', '8073fffffffffff', '805dfffffffffff',
  '808ffffffffffff', '80c1fffffffffff', '80abfffffffffff', '80bffffffffffff',
  '80b5fffffffffff', '80d3fffffffffff', '80effffffffffff', '80e5fffffffffff'
  )

children_cells <- unlist(h3r::cellToChildren(cells, 1L))

mapdeck(libraries = "h3", style = mapdeck_style("dark"))  %>%
  add_h3(
    data = data.frame(x = c(cells, children_cells))
    , hexagon = "x"
    , fill_colour = "x"
    , fill_opacity = 0.5
    , tooltip = "x"
    , stroke_colour = "#000000"
    , stroke_width = 50000
  )
```

\

Let's zoom in to see what is happening.

```{r}
mapdeck::set_token(secret::get_secret("MAPBOX"))

cells <- c('8081fffffffffff')

children_cells <- unlist(h3r::cellToChildren(cells, 1L))

mapdeck(
  libraries = "h3"
  , location = rev(as.numeric(cellToLatLng(cells)))
  , zoom = 3
  , style = mapdeck_style("dark")
  )  %>%
  add_h3(
    data = data.frame(x = c(cells, children_cells))
    , hexagon = "x"
    , fill_colour = "x"
    , fill_opacity = 0.5
    , tooltip = "x"
    , stroke_colour = "#000000"
    , stroke_width = 50000
    , update_view = TRUE
  )
```

\

We see the vertices of the parent cell is on the vertexes of its child cells. This means that the orientation of each cell changes by 19.1 degs at each resolution. What happens if we go down further?

```{r}
mapdeck::set_token(secret::get_secret("MAPBOX"))

cells <- c('8081fffffffffff')


children_cells <- unlist(h3r::cellToChildren(cells, 1L))

children_cells_res2 <- unlist(h3r::cellToChildren(children_cells[1], 2L))

children_cells_res3 <- unlist(h3r::cellToChildren(children_cells_res2[1], 3L))

children_cells_res4 <- unlist(h3r::cellToChildren(children_cells_res3[1], 4L))

mapdeck(
  libraries = "h3"
  , location = rev(as.numeric(cellToLatLng(cells)))
  , zoom = 3
  , style = mapdeck_style("dark")
  )  %>%
  add_h3(
    data = data.frame(x = c(cells, children_cells, children_cells_res2, children_cells_res3, children_cells_res4))
    , hexagon = "x"
    , fill_colour = "x"
    , fill_opacity = 0.4
    , tooltip = "x"
    , stroke_colour = "#000000"
    , stroke_width = 500
    , update_view = TRUE
  )
```
We can find that the top vertex of the resolution 0 cell is on the left of the top resolution 1 cell, while the top vertex of the resolution 1 cell is on the right of the top resolution 2 cell. The top vertex of the resolution 2 cell is on the left of the top resolution 3 cell again. This means that this 19.1 degs of change in direction differs for odd and even resolutions.

```{r references, include = FALSE}
```

## References

1. H3: Tiling the Earth with Hexagons [Youtube - Uber Engineering](https://www.youtube.com/watch?v=ay2uwtRO3QE&t=1487s)
2. Tables of Cell Statistics Across Resolutions [h3Geo.org](https://h3geo.org/docs/core-library/restable)

